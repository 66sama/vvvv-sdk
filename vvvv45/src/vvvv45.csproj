<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="Build">
  <PropertyGroup>
    <ProjectGuid>{FA8072CA-3343-4199-AC22-62B9E352BAE8}</ProjectGuid>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>
    <TargetFrameworkVersion>v4.0</TargetFrameworkVersion>
    <StartAction>Program</StartAction>
    <StartProgram>..\vvvv.exe</StartProgram>
  </PropertyGroup>
  
  <PropertyGroup>
    <CoreOutputDir>..\lib\core\</CoreOutputDir>
    <PluginsOutputDir>..\lib\nodes\plugins\</PluginsOutputDir>
    <EditorsOutputDir>..\lib\nodes\editors\</EditorsOutputDir>
  </PropertyGroup>

  <ItemGroup>
    <ProjectsToBuild Include="core\**\*.csproj;
                              gui\**\*.csproj">
      <OutputDir>$(MSBuildProjectDirectory)\$(CoreOutputDir)</OutputDir>
    </ProjectsToBuild>
    <ProjectsToBuild Include="nodes\plugins\**\*.csproj">
      <OutputDir>$(MSBuildProjectDirectory)\$(PluginsOutputDir)</OutputDir>
    </ProjectsToBuild>
    <ProjectsToBuild Include="nodes\editors\**\*.csproj">
      <OutputDir>$(MSBuildProjectDirectory)\$(EditorsOutputDir)</OutputDir>
    </ProjectsToBuild>
  </ItemGroup>
  
  <ItemGroup>
    <ProjectReference Include="@(ProjectsToBuild)" />
  </ItemGroup>
  
  <PropertyGroup Condition=" '$(Configuration)' == 'Debug' " />
  <PropertyGroup Condition=" '$(Configuration)' == 'Release' " />
  <PropertyGroup Condition=" '$(Platform)' == 'AnyCPU' " />
  <PropertyGroup Condition=" '$(Platform)' == 'x86' " />
  
  <PropertyGroup>
    <BuildDependsOn>$(BuildDependsOn)</BuildDependsOn>
    <RebuildDependsOn>Clean;Build</RebuildDependsOn>
    <CleanDependsOn>$(CleanDependsOn)</CleanDependsOn>
  </PropertyGroup>
  
  <Target Name="Build" DependsOnTargets="$(BuildDependsOn)">
    <MSBuild Projects="@(ProjectsToBuild)" 
             Properties="OutputPath=%(ProjectsToBuild.OutputDir);
                         BuildingInsideVisualStudio=false" />
    <!-- Delete all files which are already in lib/core -->
    <CreateItem Include="$(CoreOutputDir)**\*.*">
      <Output TaskParameter="Include" ItemName="_CoreOutputFiles_" />
    </CreateItem>
    <Delete Files="@(_CoreOutputFiles_->'$(PluginsOutputDir)%(RecursiveDir)%(Filename)%(Extension)')" />
    <Delete Files="@(_CoreOutputFiles_->'$(EditorsOutputDir)%(RecursiveDir)%(Filename)%(Extension)')" />
    
    <!-- Create lib/*.dtd file -->
    <GetVersionInfo File="..\vvvv.exe">
      <Output TaskParameter="ReturnValue" PropertyName="VersionInfo" />
    </GetVersionInfo>
    <Delete Files="..\lib\*.dtd" />
    <Copy SourceFiles="vvvv45.dtd" DestinationFiles="..\lib\$(VersionInfo).dtd" />
  </Target>
  
  <Target Name="Rebuild" DependsOnTargets="$(RebuildDependsOn)" />

  <Target Name="Clean" DependsOnTargets="$(CleanDependsOn)">
    <MSBuild Projects="@(ProjectsToBuild)" 
             Targets="Clean" 
             Properties="OutputPath=%(ProjectsToBuild.OutputDir)" 
             Condition=" '$(BuildingInsideVisualStudio)' == 'false' "/>
    <CreateItem Include="%(ProjectsToBuild.OutputDir)*.dll;%(ProjectsToBuild.OutputDir)*.xml;%(ProjectsToBuild.OutputDir)*.pdb">
      <Output ItemName="GeneratedFiles" TaskParameter="Include" />
    </CreateItem>
    <Delete Files="@(GeneratedFiles)" />
  </Target>
  
  <!-- Freeframe -->
  <PropertyGroup>
    <FreeframeOutputDir>..\lib\nodes\freeframes\</FreeframeOutputDir>
    <DirectShowFilterOutputDir>..\lib\nodes\directshowfilter\</DirectShowFilterOutputDir>
  </PropertyGroup>
  <ItemGroup>
    <FreeframeProjects Include="nodes\freeframes\**\*.cbp" Exclude="nodes\freeframes\Template*\**\*.cbp" />
    <DirectShowFilterProjects Include="nodes\directshowfilter\**\*.dproj" />
  </ItemGroup>
  
  <PropertyGroup>
    <ZipSteps>_PreZip_;_Zip_;_PostZip_</ZipSteps>
    <ZipOutputDir>..\..\</ZipOutputDir>
    <TempBaseDir>$(ZipOutputDir)temp\</TempBaseDir>
  </PropertyGroup>
  <Target Name="Zip">
    <CallTarget Targets="$(ZipSteps)" RunEachTargetSeparately="True" />
  </Target>
  <Target Name="_PreZip_">
    <RemoveDir Directories="$(TempBaseDir)" />
  </Target>
  <Target Name="_Zip_">
    <GetVersionInfo File="..\vvvv.exe">
      <Output TaskParameter="ReturnValue" PropertyName="VersionInfo" />
    </GetVersionInfo>
    <PropertyGroup>
      <TempDir>$(TempBaseDir)vvvv_$(VersionInfo)\</TempDir>
      <ZipFileName>$(ZipOutputDir)vvvv_$(VersionInfo).zip</ZipFileName>
    </PropertyGroup>
    <CreateItem Include="..\**\*.*" 
                Exclude="..\*.rsm;
                         ..\**\.gitignore;
                         ..\**\*.pdb;
                         ..\src\**\*.*;
                         ..\tests\**\*.*;
                         ..\addonpack\**\*.*;
                         ..\lib\nodes\plugins\*\bin\**\*.*">
      <Output ItemName="OutputFiles" TaskParameter="Include" />
    </CreateItem>
    <Copy SourceFiles="@(OutputFiles)" 
          DestinationFiles="@(OutputFiles->'$(TempDir)%(RecursiveDir)%(Filename)%(Extension)')" />
    <Exec Command="attrib +H $(TempDir)vvvv.exe.config" />
    <Exec Command="vvvv.exe /nodelist" WorkingDirectory="$(TempDir)" />
    <CreateItem Include="$(TempDir)\**\*.*">
      <Output ItemName="ZipFiles" TaskParameter="Include" />
    </CreateItem>
    <Zip Files="@(ZipFiles)" 
         WorkingDirectory="$(TempBaseDir)" 
         ZipFileName="$(ZipFileName)" 
         ZipLevel="9" />
  </Target>
  <Target Name="_PostZip_">
    <RemoveDir Directories="$(TempBaseDir)" />
  </Target>
  
  <Import Project="vvvv45.targets"/>
</Project>